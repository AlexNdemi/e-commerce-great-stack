ServerRoot "/usr/local/apache2"
Listen 80

LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule headers_module modules/mod_headers.so
LoadModule unixd_module modules/mod_unixd.so

User daemon
Group daemon
ServerAdmin you@example.com
ServerName localhost

ErrorLog /proc/self/fd/2
LogLevel warn

<VirtualHost *:80>
    ProxyPreserveHost On
    ProxyRequests Off
    
    # CORS Headers
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS,X-Requested-With"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
    Header always set Access-Control-Allow-Credentials "true"
    
    RewriteEngine On
    
    # Handle OPTIONS requests
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]
    
    # WebSocket proxy for Vite HMR
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/(.*)$ ws://react-frontend:5173/$1 [P,L]
    
    # Strip /api prefix and proxy to backend
    # /api/auth/login -> /auth/login
    RewriteCond %{REQUEST_URI} ^/api/(.*)$
    RewriteRule ^/api/(.*)$ http://yii-backend:80/$1 [P,L]
    ProxyPassReverse /api http://yii-backend:80/
    
    # Proxy everything else to frontend
    ProxyPass / http://react-frontend:5173/
    ProxyPassReverse / http://react-frontend:5173/
</VirtualHost>